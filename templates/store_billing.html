{% extends "store_base.html" %}
{% load static %}
{% block title %}Billing{% endblock %}
{% block content %}
<main id="main" class="main">
  <div class="container">
    <h2 class="text-center">Best Buy</h2>
    <form action="" method="POST">
      {% csrf_token %}
      
      <!-- Flexbox for Name and Phone No -->
      <div class="d-flex justify-content-between mb-3">
        <div class="form-group flex-grow-1 mr-2">
          <label for="party">Name</label>
          <input
            type="text"
            class="form-control"
            name="name"
            id="party"
            required
          />
        </div>
        <div class="form-group flex-grow-1 ml-2">
          <label for="phoneNo">Phone No</label>
          <input
            type="text"
            class="form-control"
            name="number"
            id="phoneNo"
          />
        </div>
      </div>

      <div class="d-flex justify-content-between mb-3">
        <div class="form-group">
          <label for="billNumber">Order Id</label>
          <input
            type="text"
            name="order_id"
            class="form-control"
            value="{{ order_id }}"
            id="billNumber"
            readonly
          />
        </div>
        <div class="form-group">
          <label for="billDate">Bill Date</label>
          <input
            type="date"
            class="form-control"
            name="date"
            id="billDate"
          />
        </div>
      </div>

      <div class="form-group col-md-6">
        <label for="productSelect">Select Product</label>
        <select id="productSelect" class="form-control" data-live-search="true">
          <option value="">-- Select Product --</option>
          {% for product in product_list %}
            <option value="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}">
              {{ product.name }} - ${{ product.price }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group mt-3">
        <h4>Product List</h4>
        <div class="table-responsive">
          <table class="table table-bordered" id="productTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Product Name</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Tax (%)</th>
                <th>Discount (%)</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Product rows will be added here -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="form-group text-right mt-2">
        <h5>Total Amount: $<span id="grandTotal">0.00</span></h5>
        <button type="submit" class="btn btn-success mt-5">Save</button>
      </div>
      
      <!-- Hidden field for serialized product data -->
      <input type="hidden" name="product_data" id="productData">
    </form>
  </div>
</main>

<script>
  let productTableBody = document.querySelector("#productTable tbody");
  let grandTotalElement = document.getElementById("grandTotal");
  let rowIndex = 1; // Initialize row index

  function updateTotalAmount() {
    let totalAmount = 0;
    document.querySelectorAll("#productTable tbody tr").forEach(row => {
      totalAmount += parseFloat(row.querySelector(".total").textContent);
    });
    grandTotalElement.textContent = totalAmount.toFixed(2);
  }

  function calculateRowTotal(row) {
    let quantity = row.querySelector(".quantity").value;
    let price = row.querySelector(".price").textContent;
    let tax = row.querySelector(".tax").value;
    let discount = row.querySelector(".discount").value;

    let total = quantity * price;
    total += total * (tax / 100);
    total -= total * (discount / 100);

    row.querySelector(".total").textContent = total.toFixed(2);
  }

  document.getElementById('productSelect').addEventListener('change', function() {
    let selectedOption = this.options[this.selectedIndex];
    if (!selectedOption.value) return;

    let productId = selectedOption.value;
    let productName = selectedOption.getAttribute('data-name');
    let productPrice = selectedOption.getAttribute('data-price');

    let existingRow = document.querySelector(`#productTable tbody tr[data-id="${productId}"]`);
    if (existingRow) {
      let quantityInput = existingRow.querySelector(".quantity");
      quantityInput.value = parseInt(quantityInput.value) + 1;
      calculateRowTotal(existingRow);
    } else {
      let newRow = document.createElement("tr");
      newRow.setAttribute("data-id", productId);
      newRow.innerHTML = `
        <td>${rowIndex++}</td> <!-- Sequential index -->
        <td>${productName}</td>
        <td><input type="number" class="form-control quantity" value="1" min="1" /></td>
        <td class="price">${productPrice}</td>
        <td><input type="number" class="form-control tax" value="0" min="0" /></td>
        <td><input type="number" class="form-control discount" value="0" min="0" /></td>
        <td class="total">${productPrice}</td>
        <td><button type="button" class="btn btn-danger remove-product">Remove</button></td>
      `;
      productTableBody.appendChild(newRow);
      calculateRowTotal(newRow);
    }

    updateTotalAmount();

    // Reset select
    this.selectedIndex = 0;
  });

  productTableBody.addEventListener('input', function(e) {
    if (e.target.classList.contains("quantity") || e.target.classList.contains("tax") || e.target.classList.contains("discount")) {
      let row = e.target.closest("tr");
      calculateRowTotal(row);
      updateTotalAmount();
    }
  });

  productTableBody.addEventListener('click', function(e) {
    if (e.target.classList.contains("remove-product")) {
      let row = e.target.closest("tr");
      row.remove();
      updateTotalAmount();
      // Re-index remaining rows
      rowIndex = 1;
      document.querySelectorAll("#productTable tbody tr").forEach(row => {
        row.querySelector("td:first-child").textContent = rowIndex++;
      });
    }
  });

  // Serialize product data into hidden field before form submission
  document.querySelector('form').addEventListener('submit', function() {
    let productData = [];
    document.querySelectorAll("#productTable tbody tr").forEach(row => {
      productData.push({
        id: row.getAttribute('data-id'),
        quantity: row.querySelector(".quantity").value,
        tax: row.querySelector(".tax").value,
        discount: row.querySelector(".discount").value,
      });
    });
    document.getElementById('productData').value = JSON.stringify(productData);
  });
</script>
<script src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>

{% endblock %}
