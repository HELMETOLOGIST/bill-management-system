{% extends "store_base.html" %}
{% load static %}
{% block title %}Billing{% endblock %}

<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- jQuery Validation CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.css" rel="stylesheet"/>
<!-- jQuery Validation JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<!-- Toastr CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Custom CSS for validation error message and total amount styling -->
<style>
  label.error {
    color: red;
    font-weight: bold;
  }
  #totalAmountContainer {
    display: inline-block;
    border: 2px solid #000;
    padding: 10px;
    border-radius: 5px;
    font-size: 18px;
    background-color: #f9f9f9;
  }
  #gstToggle {
    margin-left: 15px;
  }
</style>

{% block content %}
<main id="main" class="main">
  <div class="container">
    <h2 class="text-center">Best Buy</h2>
    <form action="" method="POST" id="billingForm">
      {% csrf_token %}
      
      <!-- Flexbox for Name and Phone No -->
      <div class="d-flex justify-content-between mb-3">
        <div class="form-group flex-grow-1 mr-2">
          <label style="color:black;" for="party">Name</label>
          <input
            type="text"
            class="form-control"
            name="name"
            id="party"
            required
          />
        </div>
        <div class="form-group flex-grow-1 ml-2">
          <label style="color:black;" for="phoneNo">Phone No</label>
          <input
            type="text"
            class="form-control"
            name="number"
            id="phoneNo"
          />
        </div>
      </div>

      <div class="d-flex justify-content-between mb-3">
        <div class="form-group">
          <label style="color:black;" for="billNumber">Order Id</label>
          <input
            type="text"
            name="order_id"
            class="form-control"
            value="{{ order_id }}"
            id="billNumber"
            readonly
          />
        </div>
        <div class="form-group">
          <label style="color:black;" for="billDate">Bill Date</label>
          <input
            type="date"
            class="form-control"
            name="date"
            id="billDate"
            required
          />
        </div>
      </div>

      <div class="form-group col-md-6">
        <label style="color:black;" for="productSelect">Select Product</label>
        <select id="productSelect" class="form-control" data-live-search="true">
          <option value="">-- Select Product --</option>
          {% for product in product_list %}
            <option 
              value="{{ product.id }}" 
              data-name="{{ product.name }}" 
              data-price="{{ product.price }}"
              data-stock="{{ product.stock }}"
              {% if product.stock <= 0 %} disabled style="color: grey;" {% endif %}
            >
              {{ product.name }} - ${{ product.price }}
              {% if product.stock <= 0 %} (Out of Stock) {% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group mt-3">
        <h4 style="color:black;">Product List</h4>
        <div class="table-responsive">
          <table class="table table-bordered" id="productTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Product Name</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Tax (%)</th>
                <th>Discount (%)</th>
                <th>Total</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Product rows will be added here -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="form-group text-right mt-2">
        <h5 style="color:black;">Total Amount: 
          <span id="totalAmountContainer">$<span id="grandTotal">0.00</span></span>
          <label id="gstToggle">
            <input type="hidden" name="gst_applied" id="gstApplied" value="true">
            <input type="checkbox" id="gstCheckbox" checked> Apply GST (18%)
          </label>
        </h5>
        <button type="submit" class="btn btn-success mt-5">Save</button>
      </div>
      
      <!-- Hidden field for serialized product data -->
      <input type="hidden" name="product_data" id="productData">
    </form>
  </div>
</main>

<script>
$(document).ready(function() {
  // Stock tracking object
  let stock = {};
  let gstRate = 18; // GST rate of 18%


  function updateGstApplied() {
    $("#gstApplied").val($("#gstCheckbox").is(":checked") ? "true" : "false");
  }

  // Call the update function when the checkbox state changes
  $("#gstCheckbox").change(function() {
    updateGstApplied();
    updateTotalAmount();
  });

  // Initial setup of gst_applied value based on the default checkbox state
  updateGstApplied();

  // Function to update stock
  function updateStock(productId, quantityChange) {
    if (!stock[productId]) {
      // Initialize stock if not present
      let productStock = parseInt($(`#productSelect option[value="${productId}"]`).data('stock'));
      stock[productId] = productStock;
    }
    stock[productId] -= quantityChange;
  }

  // Custom validation method to prevent spaces in name
  $.validator.addMethod("noSpace", function(value, element) {
    return value.indexOf(" ") < 0;
  }, "Spaces are not allowed.");

  // Custom validation method to check for products in the table
  $.validator.addMethod("productsAdded", function(value, element) {
    return $("#productTable tbody tr").length > 0;
  }, "At least one product must be added.");

  // Initialize jQuery Validation
  $("#billingForm").validate({
    rules: {
      name: {
        required: true,
        minlength: 3,
        noSpace: true
      },
      number: {
        required: true,
        digits: true,
        minlength: 10,
        maxlength: 10
      },
      date: {
        required: true
      },
      product_data: {
        productsAdded: true
      }
    },
    messages: {
      name: {
        required: "Name is required",
        minlength: "Name must be at least 3 letters",
        noSpace: "Name cannot contain spaces"
      },
      number: {
        required: "Phone number is required",
        digits: "Phone number must be 10 digits",
        minlength: "Phone number must be 10 digits",
        maxlength: "Phone number must be 10 digits"
      },
      date: {
        required: "Bill date is required"
      },
      product_data: {
        productsAdded: "At least one product must be added."
      }
    },
    submitHandler: function(form) {
      let productData = [];
      let valid = true;

      // Collect product data
      $("#productTable tbody tr").each(function() {
        let quantity = parseInt($(this).find(".quantity").val());
        if (quantity <= 0) {
          toastr.error("Quantity must be greater than zero.");
          valid = false;
          return false; // Exit the loop
        }
        productData.push({
          id: $(this).data('id'),
          quantity: $(this).find(".quantity").val(),
          tax: $(this).find(".tax").val(),
          discount: $(this).find(".discount").val(),
        });
      });

      if (!valid) return;

      $("#productData").val(JSON.stringify(productData));
      toastr.success("Form submitted successfully!");
      form.submit(); // Proceed with form submission
    }
  });

  // Update total amount when product quantity, tax, or discount changes
  function updateTotalAmount() {
    let totalAmount = 0;
    $("#productTable tbody tr").each(function() {
      let rowTotal = parseFloat($(this).find(".total").text());
      totalAmount += rowTotal;
    });

    if ($("#gstCheckbox").is(":checked")) {
      totalAmount += totalAmount * (gstRate / 100);
    }

    $("#grandTotal").text(totalAmount.toFixed(2));
  }

  function calculateRowTotal(row) {
    let quantity = $(row).find(".quantity").val();
    let price = $(row).find(".price").text();
    let tax = $(row).find(".tax").val();
    let discount = $(row).find(".discount").val();

    let total = quantity * price;
    total += total * (tax / 100);
    total -= total * (discount / 100);

    $(row).find(".total").text(total.toFixed(2));
  }

  $("#productSelect").change(function() {
    let selectedOption = this.options[this.selectedIndex];
    if (!selectedOption.value) return;

    let productId = selectedOption.value;
    let productName = selectedOption.getAttribute("data-name");
    let productPrice = selectedOption.getAttribute("data-price");

    // Check if product is already in the table
    let existingRow = $(`#productTable tbody tr[data-id="${productId}"]`);
    if (existingRow.length) {
      let quantityField = existingRow.find(".quantity");
      let newQuantity = parseInt(quantityField.val()) + 1;

      if (newQuantity > stock[productId]) {
        toastr.error("Insufficient stock for this product.");
        return;
      }

      quantityField.val(newQuantity);
      calculateRowTotal(existingRow);
    } else {
      // Add a new row if product is not in the table
      let productStock = stock[productId] || parseInt(selectedOption.getAttribute("data-stock"));

      if (productStock <= 0) {
        toastr.error("Product is out of stock.");
        return;
      }

      let newRow = `
        <tr data-id="${productId}">
          <td>${productId}</td>
          <td>${productName}</td>
          <td><input type="number" class="form-control quantity" value="1" min="1" max="${productStock}"></td>
          <td class="price">${parseFloat(productPrice).toFixed(2)}</td>
          <td><input type="number" class="form-control tax" value="0" min="0" max="100"></td>
          <td><input type="number" class="form-control discount" value="0" min="0" max="100"></td>
          <td class="total">${parseFloat(productPrice).toFixed(2)}</td>
          <td><button type="button" class="btn btn-danger btn-sm remove-product">Remove</button></td>
        </tr>
      `;
      $("#productTable tbody").append(newRow);
      updateStock(productId, 1);
    }

    updateTotalAmount();
  });

  // Update row total and grand total when quantity, tax, or discount changes
  $("#productTable").on("input", ".quantity, .tax, .discount", function() {
    let row = $(this).closest("tr");
    let productId = row.data("id");
    let newQuantity = parseInt(row.find(".quantity").val());
    let oldQuantity = stock[productId] + newQuantity;

    if (newQuantity > oldQuantity) {
      toastr.error("Insufficient stock for this product.");
      row.find(".quantity").val(oldQuantity);
      return;
    }

    updateStock(productId, newQuantity - oldQuantity);
    calculateRowTotal(row);
    updateTotalAmount();
  });

  // Remove product row and update stock
  $("#productTable").on("click", ".remove-product", function() {
    let row = $(this).closest("tr");
    let productId = row.data("id");
    let quantity = parseInt(row.find(".quantity").val());

    updateStock(productId, -quantity);
    row.remove();
    updateTotalAmount();
  });

  // Toggle GST application
  $("#gstCheckbox").change(function() {
    updateTotalAmount();
  });
});
</script>
<script>
  // Get today's date in the format YYYY-MM-DD
  const today = new Date().toISOString().split('T')[0];
  // Set the value of the date input to today's date
  document.getElementById('billDate').value = today;
</script>
{% endblock %}
